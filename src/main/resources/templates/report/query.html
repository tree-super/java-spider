<!DOCTYPE>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	<title>持续注意力测试系统 | 报告查询</title>
    <meta name="description" content="健康测评系统">
    
    <meta name="renderer" content="webkit"/>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge"/>
    <meta http-equiv="pragma" content="no-cache" />
    <meta http-equiv="cache-control" content="no-cache" />
    <meta http-equiv="expires" content="0" />
	<th:block th:replace="common/res::res"></th:block>

</head>

<body style="height:100%;">
	<div class="r-min-width">
		<form id="tb">
		<div class="ui-gauge">
			<div class="ui-help">帮助</div>
			<ul>
				<li style="height:30px;display:none" id="state">
					<div class="ui-state" style="position: absolute;left: 90px;">
						<label>未出报告<input type="checkbox" value="0" id="CState0" name="CState" checked="checked"></label>
						<label>已出报告<input type="checkbox" value="1" id="CState1" name="CState" checked="checked"></label>
						<!-- 作废，还原，删除 -->
						<label>作废报告<input type="checkbox" value="2" id="CState2" name="CState" checked="checked"></label>
					</div>
					<div id="lbTitleWindow" class="easyui-window" title="选择量表" data-options="modal:false,closed:true,collapsible:false,minimizable:false,maximizable:false" style="width:80%;height:70%;padding:10px;overflow:auto">
						<jsp:include page="lbTitle.jsp">
							<jsp:param value="1" name="type"/>
						</jsp:include>
				    </div>
				</li>
				<div class="gauge-content" style="display:none">
					<li>
						<em>量表大类&nbsp;</em>
						<div class="ui-gauge-box">
							<span>儿童体格生长测评</span>
						</div>
					</li>
					<li>
						<em>量表名称&nbsp;</em>
						<div class="ui-gauge-box">
							<span>儿童体格生长测评</span>
						</div>
					</li>
				</div>
			</ul>
			<ol class="clear" id="screeningMore">
				<li class="col3">
					<em>手机号码&nbsp;</em>
					<input type="text" name="CPhoneNo" class="easyui-validatebox" data-options="validType:'isPhoneNo'" />
				</li>
				<li class="col3">
					<em>姓名&nbsp;</em>
					<input type="text" name="CChildNme"/>
				</li>
				<li class="col3">
					<em>性别&nbsp;</em>
					<select id="CChildSex" name="CChildSex" class="easyui-combobox" data-options="editable:false,width:200,panelHeight:80">
						<option value="M">男</option>
						<option value="F">女</option>
					</select>
				</li>
				<li class="col3">
					<em>门诊/住院号&nbsp;</em>
					<input type="text" name="CMenzhenNo"/>
				</li>
				<li class="col3">
					<em>出生日期&nbsp;</em>
					<div class="ui-gauge-input col-sm" style="margin-bottom: 8px;">
						<input type="text" id="TBirthBgn" name="birthBgn" class="easyui-datebox" data-options="editable:false,validType:['isDate']"/>
					</div>
				</li>
				<li class="col3">
					<em>测评时间，从&nbsp;</em>
					<div class="ui-gauge-input col-sm" style="margin-bottom: 8px;">
						<input type="text" id="TBgnTm" name="TBgnTm" class="easyui-datebox" data-options="editable:false,validType:['isDate']"/>
					</div>
					<em>到&nbsp;</em>
					<div class="ui-gauge-input col-sm">
						<input type="text" id="TEndTm" name="TEndTm" class="easyui-datebox" data-options="editable:false,validType:['isDate']"/>
					</div>
				</li>
			</ol>
			<div class="ui-screening">
				<div class="ui-screening-more" onclick="screeningMore(this)">
					<span>展开</span>
					<i class="iconfont icon-jiantou-bottom"></i>
				</div>
			</div>
			<div class="ui-btn">
				<a href="javascript:void(0)" class="queryBtn_">
					<em class="iconfont icon-fangdajing"></em>
					<i>查询</i>
				</a>
				<a href="javascript:void(0)" onclick="clearForm()">
					<em class="iconfont icon-delete"></em>
					<i>清空</i>
				</a>
				<span style="height:14px;line-height:33px;color:blue;">展开条件，选择测评时间范围，默认查询当天</span>
			</div>
		</div>
		</form>
		<table id="query" class="easyui-datagrid" style="width:100%; height:100%;" rownumbers="true" data-options="fit:true,toolbar:'#tb',footer:'#ft',pagination:true,pagination:true,pageSize:20,singleSelect:true">
			<thead>
		        <tr>
		            <th field="CPkId" data-options="hidden:true">主键</th>
		            <th field="CLbId" data-options="hidden:true">量表id</th>
		            <th field="CState" data-options="hidden:true">量表状态</th>
		            <th field="CPhoneNo" data-options="hidden:true">电话</th>
		            <th field="CState" data-options="hidden:true">状态</th>
		            <th field="CChildNme" style='width:15%'>姓名</th>
		            <th field="CChildSex" style='width:10%' data-options="formatter:formatSex1">性别</th>
		            <th field="TBirthday" style='width:15%'>出生日期</th>
		            <th field="CAns8" style='width:30%' data-options="formatter:formatResult">结论</th>
		            <th field="TTestTm" style='width:15%'>测评时间</th>
<!--		            <th field="CLbIdNme" style='width:30%'>量表名称</th>-->
		            <th field="CEffMrk" style='width:14%' data-options="formatter:formatState">状态</th>
		        </tr>
		    </thead>
		</table>
		<div id="ft" style="padding:5px 8px 10px 8px;height:auto">
		    <a href="javascript:report()" class="iconfont icon-chakan" title="查看报告）">查看报告</a>

		    <!-- 作废，还原，删除 -->
		    <a href="javascript:invalidReport()" class="iconfont icon-zuofei" title="">作废</a>
		    <a href="javascript:recoverReport()" class="iconfont icon-huifu" title="">恢复</a>
		    <a href="javascript:deleteQuest()" class="iconfont icon-del" title="未产生报告可删除，若已生成报告则只能作废">删除</a>

		</div>
	</div>
	
	<script type="text/javascript">
	
    var now = new Date(utils.SYS_DATE);
    
			$(document).ready(function(){
			    $("#CChildSex").combobox("setValue","");
				//初始化使用帮助页面
				utils.initHelpWindow(true);
				//对datagrid设置属性，必须在initDataGrind之前，否则分页失效，暂未查出问题
				$("#query").datagrid({
					onDblClickRow:function(index,row){
						var state = row.CState;//1已出报告 0未出报告
						if(state=='0'||state=='3'|| state=='4'){
							quest();
						}else if(state=='1'||state=='2'){//作废，还原，删除
							report();
						}
					}
				});
				utils.initDataGrid();

				// 当天
	            $("#TBgnTm").datebox("setValue", now.getFullYear() + "-" + (now.getMonth() + 1) + "-" + now.getDate());
	            $("#TEndTm").datebox("setValue", now.getFullYear() + "-" + (now.getMonth() + 1) + "-" + now.getDate());
				query();
				
				utils.closeLoading();
			});


			//点击显示隐藏筛选条件
			//***************************************************************************************
			//*****注意：由于form表单的结构不一样，量表的查询和（听力筛查、体格检查）的该方法不一样123************
			//***************************************************************************************
			function screeningMore(obj){
				var maxHeight=122;//展开的高度
				var minHeight=38;//收缩的高度
				var delay = 300;
				if($("#screeningMore").css("height")==(minHeight+"px")){
					$("#screeningMore").animate({"height":maxHeight+"px"},delay);
					$(obj).find("span").text("收起");
					$(obj).find("i").css({"transform":"rotate(180deg)","-webkit-transform":"rotate(180deg)"});
					$("#state").show(delay);

					$(".datagrid-view").animate({"height":$(".datagrid-view").height()-maxHeight},delay);
					$(".datagrid-body").animate({"height":$(".datagrid-body").height()-maxHeight},delay);

				}else{
					$("#screeningMore").animate({"height":minHeight+"px"},delay);
					$(obj).find("span").text("展开");
					$(obj).find("i").css({"transform":"rotate(360deg)","-webkit-transform":"rotate(360deg)"});
					$("#state").hide(delay);

					$(".datagrid-view").animate({"height":$(".datagrid-view").height()+maxHeight},delay);
					$(".datagrid-body").animate({"height":$(".datagrid-body").height()+maxHeight},delay);
				}
			}

			//清空查询条件
			function clearForm(){
				$("#tb").form("clear");
				$(".gauge-content").find("div.ui-gauge-box").html("");
				$("#CState0").prop("checked",true);
				$("#CState1").prop("checked",true);
				$("#queryAllSpan").html("(默认查询全部)");
				$("#queryAllSpan").parent().css("width","130px");
				$("#queryAllSpan").parent().next().css("left","300px");
				$(".gauge-content").hide();

			}

			function query(){
				var state0 = $("#CState0").is(":checked");
				var state1 = $("#CState1").is(":checked");
				//作废，还原，删除
				var state2 = $("#CState2").is(":checked");
				if(!state0 && !state1 && !state2){
					utils.alert("请选择报告状态",function(){
						return false;
					});
				}
				//判断出生日期结束时间不能在开始时间之前
				var TBirthBgn = new Date($("#TBirthBgn").datebox("getValue"));//转换为开始时间
				//var TBirthEnd = new Date($("#TBirthEnd").datebox("getValue"));//转换为结束时间
				// if(TBirthBgn.getTime()>TBirthEnd.getTime()){
				// 	utils.alert("出生日期结束时间不能在开始时间之前");
				// 	return false;
				// }
				var TBgnTm= new Date($("#TBgnTm").datebox("getValue"));//转换为开始时间
				var TEndTm = new Date($("#TEndTm").datebox("getValue"));//转换为结束时间
				if(TBgnTm.getTime()>TEndTm.getTime()){
					utils.alert("测评时间结束时间不能在开始时间之前");
					return false;
				}
				//作废，还原，删除
				var params = {"state0":state0,"state1":state1,"state2":state2};

				utils.ajax({
					control:"report/list",
					method:"query",
					params:params,
					forms:["tb"],
					validate:true,
					sucFun:function(mrk,bd,cd){
						if(mrk){
							// utils.showMsg("查询成功");
						}else{
							utils.showMsg("查询失败");
						}
					}
				});
			}

			function formatSex1(value,row,index){
				if("F"==value)
					return "女";
				else
					return "男";
			}

			function formatResult(value,row,index){
				return '<span>' + row.CAns7 +'</span>注意力<span>'+ row.CAns8 +'</span>障碍';
			}

			function formatState(value,row,index){
				//是否有效（0已作废，1有效）
				if("1"==value)
					return "<span style='color:green'>已出报告</span>";
				else if("0"==value)
					return "<span style='color:red'>已作废</span>";
			}

			function quest(){
				var row = $("#query").datagrid('getSelected');
				if(!row){
				 	$.messager.alert('提示','请选择一条记录');
				 	return;
				 }else{
			 		var pkId = row.CPkId;
			 		var lbId = row.CLbId;
			 	if(row.CState=="1" || row.CState=="2"||row.CState=="3"){//作废，还原，删除
			 		var url = +"/jsp/lb/" +lbId+".jsp?pkId="+pkId+"&model=view";
			 		var title = row.CChildNme;
			 		parent.utils.addTab({
			 			"url":url,
						"title":title
			 		});
			 	}else{
			 		var url = "/jsp/lb/" +lbId+".jsp?pkId="+pkId+"&model=";
			 		if(row.CState=="4"){
			 			url+="modify";
			 		}else{
			 			url+="edit";
			 		}
			 		var title = row.CChildNme;
			 		parent.utils.addTab({
			 			"url":url,
						"title":title
			 		});
			 	}
			 }
		}

		function report(){
			var row = $("#query").datagrid('getSelected');
			if(!row) {
				$.messager.alert('提示', '请选择一条记录');
				return;
			}
			var pkId = row.CPkId;
			var lbId = row.CLbId;
			var url = "/report/0809?pkId="+pkId;
			var title = row.CChildNme;
			parent.utils.addTab({
				"url":url,
				"title":title+"报告"
			});
		}

		//量表选择页面点击确认后回填数据
		function setLbTitle(){
			//lbIds_=[],kinds_=[],lbNames_=[],kindNames_;
			//没有选择任何量表 或者 大类
			if(lbNames_.length==0&&kindNames_.length==0){
				$("#queryAllSpan").html("(默认查询全部)");
				$("#queryAllSpan").parent().css("width","130px");
				$("#queryAllSpan").parent().next().css("left","300px");
				$(".gauge-content").hide();
			}else{
				$("#queryAllSpan").html("");
				$("#queryAllSpan").parent().css("width","45px");
				$("#queryAllSpan").parent().next().css("left","205px");

				if(kindNames_.length!=0){
					var liObj = $(".gauge-content").find("li").eq(0);
					var divObj = liObj.find("div");
					divObj.html("");
					for(var i=0;i<kindNames_.length;i++){
						divObj.append("<span>"+kindNames_[i]+"</span>");
					}
					liObj.show();
					$(".gauge-content").show();
				}else{
					liObj = $(".gauge-content").find("li").eq(0).hide();
				}

				if(lbNames_.length!=0){
					var liObj = $(".gauge-content").find("li").eq(1);
					var divObj = liObj.find("div");
					divObj.html("");
					for(var i=0;i<lbNames_.length;i++){
						divObj.append("<span>"+lbNames_[i]+"</span>");
					}
					liObj.show();
					$(".gauge-content").show();
				}else{
					liObj = $(".gauge-content").find("li").eq(1).hide();
				}
			}
		}


		//<!-- 作废，还原，删除 -->

		//删除答题
		function deleteQuest(){
			var row = $("#query").datagrid('getSelected');
			if(!row){
			 	$.messager.alert('提示','请选择一条记录');
			 	return;
			 }else{
		 		var pkId = row.CPkId;
		 		var lbId = row.CLbId;
		 		var state = row.CState;
                   if(row.CState=="3"){
                       $.messager.alert('提示','报告远程评定中不能删除');
                       return ;
                   }else if(row.CState!="0"){
                       $.messager.alert('提示','报告只能作废，不能删除');
                       return ;
                   }else{
			 		$.messager.confirm('确认?','是否确认删除',function(r){
			 			if(!r)
			 				return;
			 			utils.ajax({
				 			service:"pcAction",
				 			method:"deleteQuest",
				 			params:{
				 				pkId:pkId
				 			},
				 			sucFun:function(mrk,bd,cd){
								if(mrk){
									utils.showMsg("删除成功");
									var rowIndex = $('#query').datagrid('getRowIndex', row);
									$('#query').datagrid('deleteRow',rowIndex);
								}else{
									$.messager.alert('提示',"报告只能作废，不能删除");
								}
							}
				 		});
			 		});
			 	}
			 }
		}


		//作废报告
		function invalidReport(){
			var row = $("#query").datagrid('getSelected');
			if(!row){
			 	$.messager.alert('提示','请选择一条记录');
			 	return;
			 }else{
		 		var pkId = row.CPkId;
		 		var lbId = row.CLbId;
		 		var state = row.CState;
			 	if(row.CState=="0"){
			 		$.messager.alert('提示','答题只能删除，不能作废');
			 		return ;
			 	}else if(row.CState=="2"){
			 		$.messager.alert('提示','该报告目前已经处于作废状态');
			 		return ;
			 	}else if(row.CState=="3"){
                   	$.messager.alert('提示','该答题远程评定中不能作废');
                   	return ;
               	}else if(row.CState=="4"){
                       $.messager.alert('提示','光片异常,请重新上传');
                       return;
				}else{
			 		$.messager.confirm('确认?','是否确认作废',function(r){
			 			if(!r)
			 				return;
			 			utils.ajax({
				 			service:"pcAction",
				 			method:"invalidReport",
				 			params:{
				 				pkId:pkId
				 			},
				 			sucFun:function(mrk,bd,cd){
								if(mrk){
									utils.showMsg("作废成功");

									row.CState = "2";
									row.CStateNme = "2";
									var rowIndex = $('#query').datagrid('getRowIndex', row);
									$('#query').datagrid('refreshRow',rowIndex);
								}
							}
				 		});
			 		});
			 	}
			 }
		}

		//恢复报告
		function recoverReport(){
			var row = $("#query").datagrid('getSelected');
			if(!row){
			 	$.messager.alert('提示','请选择一条记录');
			 	return;
			 }else{
		 		var pkId = row.CPkId;
		 		var lbId = row.CLbId;
		 		var state = row.CState;
			 	if(row.CState=="0" || row.CState=="1"||row.CState=="3"||row.CState=="4"){
			 		$.messager.alert('提示','只能恢复作废的报告');
			 		return ;
			 	}else{
			 		$.messager.confirm('确认?','是否确认恢复',function(r){
			 			if(!r)
			 				return;
			 			utils.ajax({
				 			service:"pcAction",
				 			method:"recoverReport",
				 			params:{
				 				pkId:pkId
				 			},
				 			sucFun:function(mrk,bd,cd){
								if(mrk){
									utils.showMsg("恢复成功");

									row.CState = "1";
									row.CStateNme = "1";
									var rowIndex = $('#query').datagrid('getRowIndex', row);
									$('#query').datagrid('refreshRow',rowIndex);
								}
							}
				 		});
			 		});
			 	}
			 }
		}

	</script>
	
</body>
</html>
